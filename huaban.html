<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div class="wrap">
    <canvas id="canvas" class="fl" width="600" height="400">
    </canvas>
    <div id="control" class="fl">
        <div id="canvas-color">
            <h5>画笔颜色</h5>
            <ul>
                <li style="background: #f32f15"></li>
                <li style="background: #ffc200"></li>
                <li style="background: #0018ba"></li>
                <li style="background: #5ab639"></li>
            </ul>
        </div>
        <div id="canvas-brush">
            <h5>
                画笔大小</h5>
            <span class="small-brush">细</span>
            <span class="middle-brush">中</span>
            <span class="big-brush">粗</span>
        </div>
        <div id="canvas-control">
            <h5>操作</h5>
            <span title="撤回" class="return-control">撤回</span>
            <span title="反撤回" class="next-control">反撤回</span>
            <span title="清除" class="empty-control">清除</span>
            <span title="橡皮檫" id="eraser" class="eraser-control">橡皮檫</span>
            <span title="直线"  id="line" class="line-control">直线</span>
            <span title="矩形" id="rect" class="rect-control">矩形</span>
            <span title="圆圈" id="circle" class="circle-control">圆圈</span>

        </div>
        <ul name="" class="type">
            <li class="line typeactive" data="line"></li>
            <li class="rect" data="rect"></li>
            <li class="circle" data="circle"></li>
        </ul>
        <div id="canvas-drawImage">
            <h5>
                生成图像</h5>
            <p>
                <button class="drawImage">
                    生成图像</button></p>
        </div>
    </div>
</div>
<div id="imgDiv">
</div>
<style>
    html, body, canvas, div, ul, li, h5, p
    {
        margin: 0;
        padding: 0;
        -moz-user-select: none;
        -webkit-user-select: none;
    }
    img
    {
        border: 1px #ccc solid;
    }
    ul, li
    {
        list-style: none;
    }
    .wrap
    {
        width: 740px;
        margin: 20px auto 5px;
        border: 1px #ccc solid;
        overflow: hidden;
    }
    .fl
    {
        float: left;
        display: inline;
    }
    #canvas
    {
        border-right: 1px #ccc solid;
        cursor: crosshair;
    }
    #control
    {
        width: 130px;
        height: 400px;
        margin-left: 4px;
    }
    #control div
    {
        padding: 5px;
    }
    #canvas-color ul
    {
        overflow: hidden;
    }
    #canvas-color ul li
    {
        float: left;
        display: inherit;
        width: 13px;
        height: 13px;
        border: 3px #fff solid;
        margin: 8px;
        cursor: pointer;
    }
    #canvas-color ul li.js-border-color
    {
        border-color: #000;
    }
    #canvas-brush span
    {
        display: inline-block;
        width: 10px;
        height: 10px;
        margin-left: 10px;
        background: url(images/brush.png);
        cursor: pointer;
    }
    #canvas-brush span.small-brush
    {
        background-position: -6px -6px;
    }
    #canvas-brush span.middle-brush
    {
        background-position: -31px -6px;
    }
    #canvas-brush span.big-brush
    {
        background-position: -56px -6px;
    }
    #canvas-brush span.js-bg-color
    {
        background-color: #aaa;
    }
    #canvas-control span
    {
        display: inline-block;
        width: 20px;
        height: 15px;
        background: url(images/sketchpad_icons.png);
        cursor: pointer;
    }
    #canvas-control span.return-control
    {
        background-position: -2px -148px;
    }
    #canvas-control span.next-control
    {
        background-position: right -168px;
    }
    #canvas-control span.empty-control
    {
        background-position: -2px -188px;
    }
    #canvas-control span.js-return-control
    {
        background-position: -2px -209px;
    }
    #canvas-control span.js-next-control
    {
        background-position: right -230px;
    }
    #canvas-control span.js-empty-control
    {
        background-position: -2px -251px;
    }
    #imgDiv
    {
        text-align: center;
    }
</style>
<script src="jquery.min.js"></script>
<script>
    var typechoose=$(".type li");
    // 绘制形状
    typechoose.each(function(index,ele){
        $(ele).click(function(){
            typechoose.removeClass("typeactive");
            $(this).toggleClass("typeactive");
            this.config.type=$(this).attr("data");
        })
    })
    var canvas = document.getElementById('canvas'),
        colorDiv = document.getElementById('canvas-color'),
        brushDiv = document.getElementById('canvas-brush'),
        controlDiv = document.getElementById('canvas-control'),
        drawImageDiv = document.getElementById('canvas-drawImage'),
        imgDiv = document.getElementById('imgDiv');
    function Canvas() {
        this.init.apply(this, arguments);
    }
    Canvas.prototype = {
        //存储当前表面状态数组-上一步
        preDrawAry: [],
        //存储当前表面状态数组-下一步
        nextDrawAry: [],
        //中间数组
        middleAry: [],
        //配置参数
        config: {
            lineWidth: 1,
            lineColor: "blue",
            shadowBlur: 2,
            type:"pencil",
            isMouseDown:false
        },
        init: function (oCanvas, oColor, oBrush, oControl, oDrawImage, imgDiv) {
            this.canvas = oCanvas;
            this.context = oCanvas.getContext('2d');
            this.colorDiv = oColor;
            this.brushDiv = oBrush;
            this.controlDiv = oControl;
            this.drawImageDiv = oDrawImage;
            this.imgDiv = imgDiv;
            this._initDraw();
            this._draw(oCanvas);
            this.setColor();
            this.setBrush();
            this.preClick();
            this.nextClick();
            this.clearClick();
            this.toolClick();
            // this.lineClick();
            this.drawImage(oCanvas);
        },
        _initDraw: function () {
            var preData = this.context.getImageData(0, 0, 600, 400);
            //空绘图表面进栈
            this.middleAry.push(preData);
        },
        //涂鸦主程序
        _draw: function (oCanvas, context) {
            var self = this;
            oCanvas.onmousedown = function (e) {
                var draw=new Draw(self.context,{color: self.config.lineColor,width: self.config.lineWidth});//实例化构造函数
                self.config.isMouseDown = true;
                var x = e.clientX,
                    y = e.clientY,
                    left = this.parentNode.offsetLeft,
                    top = this.parentNode.offsetTop,
                    canvasX = x - left,
                    canvasY = y - top;
                self._setCanvasStyle();
                //清除子路径
                self.context.beginPath();
                self.context.moveTo(canvasX, canvasY);
                //当前绘图表面状态
                var preData = self.context.getImageData(0, 0, 600, 400);
                //当前绘图表面进栈
                self.preDrawAry.push(preData);
                document.onmousemove = function (e) {
                    var x2 = e.clientX,
                        y2 = e.clientY,
                        t = e.target,
                        canvasX2 = x2 - left,
                        canvasY2 = y2 - top;
                    if (t == oCanvas) {
                        if(self.config.type=="eraser"&& self.config.isMouseDown){
                            self.context.clearRect(canvasX2,canvasY2, 25, 25)
                        }else if(self.config.type=="pencil") {
                            self.context.lineTo(canvasX2, canvasY2);
                            self.context.stroke();
                        }else{
                            if(self.config.type!="eraser"){
                                self.context.clearRect(0, 0, self.context.canvas.width, self.context.canvas.height);
                                if( self.middleAry.length!=0){
                                    self.context.putImageData( self.middleAry[ self.middleAry.length-1],0,0,0,0,self.context.canvas.width, self.context.canvas.height);
                                }
                            };
                            draw[self.config.type](x,y,x2,y2);
                        }
                    } else {
                        self.context.beginPath();
                    }
                }
                document.onmouseup = function (e) {
                    var t = e.target;
                    if (t == oCanvas) {
                        //当前绘图表面状态
                        var preData = self.context.getImageData(0, 0, 600, 400);
                        if (self.nextDrawAry.length == 0) {
                            //当前绘图表面进栈
                            self.middleAry.push(preData);
                        } else {
                            self.middleAry = [];
                            self.middleAry = self.middleAry.concat(self.preDrawAry);
                            self.middleAry.push(preData);
                            self.nextDrawAry = [];
                        }
                        self._isDraw();
                        self.config.isMouseDown = false;
                    }
                    this.onmousemove = null;
                }
            }
        },
        //设置画笔
        _setCanvasStyle: function () {
            this.context.lineWidth = this.config.lineWidth;
            this.context.shadowBlur = this.config.shadowBlur;
            this.context.shadowColor = this.config.lineColor;
            this.context.strokeStyle = this.config.lineColor;
        },
        //设置颜色
        setColor: function () {
            this.colorDiv.onclick = this.bind(this, this._setColor);
        },
        _setColor: function (e) {
            var t = e.target;
            if (t.nodeName.toLowerCase() == "li") {
                this.config.lineColor = t.style.backgroundColor;
                this.config.type="pencil";
            }
        },
        //设置画笔大小
        setBrush: function () {
            this.brushDiv.onclick = this.bind(this, this._setBrush);
        },
        _setBrush: function (e) {
            var t = e.target;
            if (t.nodeName.toLowerCase() == "span") {
                if (t.className.indexOf("small-brush") >= 0) {
                    this.config.lineWidth = 3;
                } else if (t.className.indexOf("middle-brush") >= 0) {
                    this.config.lineWidth = 6;
                } else if (t.className.indexOf("big-brush") >= 0) {
                    this.config.lineWidth = 12;
                }
                $('.js-bg-color').removeClass('js-bg-color');
                $(t).addClass('js-bg-color');
            }
        },
        //判断是否已涂鸦,修改按钮状态
        _isDraw: function () {
            if (this.preDrawAry.length) {
                $('.return-control').addClass('js-return-control');
                $('.return-control').removeClass('return-control');
                $('.empty-control').addClass('js-empty-control');
                $('.empty-control').removeClass('empty-control');
            } else {
                return false;
            }
        },
        //点击上一步-改变涂鸦当前状态
        preClick: function () {
            var pre = this.controlDiv.getElementsByTagName("span")[0];
            pre.onclick = this.bind(this, this._preClick);
        },
        _preClick: function () {
            if (this.preDrawAry.length > 0) {
                var popData = this.preDrawAry.pop();
                var midData = this.middleAry[this.preDrawAry.length + 1];
                this.nextDrawAry.push(midData);
                this.context.putImageData(popData, 0, 0);
            }
            if (this.nextDrawAry.length) {
                $('.next-control').addClass('js-next-control');
                $('.next-control').removeClass('next-control');
            }
            if (this.preDrawAry.length == 0) {
                $('.js-return-control').addClass('return-control');
                $('.return-control').removeClass('js-return-control');
            }
        },
        //点击下一步-改变涂鸦当前状态
        nextClick: function () {
            var next = this.controlDiv.getElementsByTagName("span")[1];
            next.onclick = this.bind(this, this._nextClick);
        },
        _nextClick: function () {
            if (this.nextDrawAry.length) {
                var popData = this.nextDrawAry.pop();
                var midData = this.middleAry[this.middleAry.length - this.nextDrawAry.length - 2];
                this.preDrawAry.push(midData);
                this.context.putImageData(popData, 0, 0);
            }
            if (this.preDrawAry.length) {
                $('.return-control').addClass('js-return-control');
                $('.return-control').removeClass('return-control');
            }

            if (this.nextDrawAry.length == 0) {
                $('.js-next-control').addClass('next-control');
                $('.next-control').removeClass('js-next-control');
            }
        },
        //清空
        clearClick: function () {
            var clear = this.controlDiv.getElementsByTagName("span")[2];
            clear.onclick = this.bind(this, this._clearClick);
        },
        _clearClick: function () {
            var data = this.middleAry[0];
            this.context.clearRect(0, 0, this.context.canvas.width, this.context.canvas.height);
            this.preDrawAry = [];
            this.nextDrawAry = [];
            this.middleAry = [this.middleAry[0]];
            this.controlDiv.getElementsByTagName("span")[0].className = "return-control";
            this.controlDiv.getElementsByTagName("span")[1].className = "next-control";
            this.controlDiv.getElementsByTagName("span")[2].className = "empty-control";
            this.controlDiv.getElementsByTagName("span")[3].className = "eraser-control";
            this.controlDiv.getElementsByTagName("span")[4].className = "line-control";
            this.controlDiv.getElementsByTagName("span")[5].className = "rect-control";
            this.controlDiv.getElementsByTagName("span")[6].className = "circle-control";

        },
        // 橡皮檫
        toolClick: function () {
            var self=this;
            $("#eraser").click(function () {
                self.config.type="eraser";
            })
            $("#line").click(function () {
                self.config.type="line";
            })
            $("#circle").click(function () {
                self.config.type="circle";
            })
            $("#rect").click(function () {
                self.config.type="rect";
            })
        },
        //生成图像
        drawImage: function () {
            var btn = this.drawImageDiv.getElementsByTagName("button")[0];
            btn.onclick = this.bind(this, this._drawImage);
        },
        _drawImage: function () {
            var url = this.canvas.toDataURL('image/png'),
                img = new Image();
            img.src = url;
            this.imgDiv.innerHTML = "";
            this.imgDiv.appendChild(img);
        },
        bind: function (obj, handler) {
            return function () {
                return handler.apply(obj, arguments);
            }
        }
    }
    new Canvas(canvas, colorDiv, brushDiv, controlDiv, drawImageDiv, imgDiv);
    function Draw(context,setting){
        this.context=context;
        this.color=setting.color||"#000";
        this.width=setting.width||"1";
    }
    Draw.prototype={
        init:function(){
            this.context.strokeStyle=this.color;
            this.context.fillStyle=this.color;
            this.context.lineWidth=this.width;
        },
        rect:function(x,y,x1,y1){
            this.init();
            this.context.beginPath();
            this.context.rect(x,y,x1-x,y1-y);
            this.context.stroke();
        },
        line:function(x,y,x1,y1){
            this.init();
            this.context.beginPath();
            this.context.moveTo(x,y);
            this.context.lineTo(x1,y1);
            this.context.stroke();
        },
        circle:function(x,y,x1,y1){
            this.init();
            var r=Math.sqrt(Math.pow(x-x1,2)+Math.pow(y-y1,2));
            this.context.beginPath();
            this.context.arc(x,y,r,0,2*Math.PI);
            this.context.stroke();
        }
    }
</script>
</body>
</html>